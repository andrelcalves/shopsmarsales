// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Order {
  id          Int      @id @default(autoincrement())
  orderId     String
  orderDate   DateTime
  productName String
  quantity    Int
  totalPrice  Float
  source      String
  createdAt   DateTime @default(now())
  status      String   @default("")
  items       OrderItem[]
  commissionFee Float?  // Net Commission Fee (taxa de comissão líquida)
  serviceFee    Float?  // Taxa de serviço bruta
  freight       Float?  // Frete (apenas canal tray)
  paymentType   String? @default("")  // Tipo de pagamento (ex: Pix - Vindi, Cartão de Crédito - Mercado Pago)
  @@unique([orderId, source])
}

model OrderItem {
  id          Int    @id @default(autoincrement())
  orderId     String
  source      String
  productCode String
  name        String
  unitPrice   Float
  discount    Float?   @default(0)  // Desconto dado pela loja no produto
  quantity    Int
  totalPrice  Float

  productId   Int?
  product     Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  order Order @relation(fields: [orderId, source], references: [orderId, source], onDelete: Cascade)

  @@unique([orderId, source, productCode])
  @@index([orderId, source])
  @@index([productId])
}

model Product {
  id        Int       @id @default(autoincrement())
  code      String    @unique   // Código único (ex: "803", "tray_803", SKU)
  name      String
  costPrice Float?
  source    String?   @default("")  // Opcional: "tray" | "shopee" | "tiktok" para saber origem
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  orderItems       OrderItem[]
  stock            ProductStock?
  productGroupItem ProductGroupItem?
}

model ProductGroup {
  id        Int      @id @default(autoincrement())
  name      String   // Nome consolidado do grupo (ex: "Legging Empina Bumbum")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items ProductGroupItem[]
  stock ProductGroupStock?
}

model ProductGroupItem {
  id             Int         @id @default(autoincrement())
  productGroupId Int
  productId      Int         @unique  // cada produto pertence a no máximo um grupo
  productGroup   ProductGroup @relation(fields: [productGroupId], references: [id], onDelete: Cascade)
  product        Product     @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productGroupId])
}

model ProductGroupStock {
  id             Int         @id @default(autoincrement())
  productGroupId Int         @unique
  quantity       Int         @default(0)
  updatedAt      DateTime    @updatedAt
  productGroup   ProductGroup @relation(fields: [productGroupId], references: [id], onDelete: Cascade)
}

model InventoryConfig {
  id             Int      @id @default(autoincrement())
  stockStartDate DateTime
  updatedAt      DateTime @updatedAt
}

model ProductStock {
  id        Int      @id @default(autoincrement())
  productId Int      @unique
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  quantity  Int      @default(0)
  updatedAt DateTime @updatedAt
}

model AdSpend {
  id        Int      @id @default(autoincrement())
  month     DateTime // sempre usar primeiro dia do mês (ex.: 2026-01-01)
  channel   String   // ex.: shopee | tiktok | tray | meta | google | etc
  amount    Float
  notes     String   @default("")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([month, channel])
  @@index([month])
}

model PaymentTypeFee {
  id          Int      @id @default(autoincrement())
  month       DateTime // primeiro dia do mês (ex.: 2026-01-01)
  channel     String   // tray (por enquanto)
  paymentType String   // ex: "Pix - Vindi", "Cartão de Crédito - Mercado Pago"
  percent     Float    // percentual da taxa sobre o valor do pedido
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([month, channel, paymentType])
  @@index([month, channel])
}

model Bill {
  id            Int      @id @default(autoincrement())
  description   String   // ex: "Fornecedor X - Lote Março"
  invoiceNumber String?  // nota fiscal (opcional)
  totalAmount   Float    // valor total da conta
  dueDate       DateTime? // data limite (opcional)
  status        String   @default("pending") // pending | partial | paid
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  payments      BillPayment[]
}

model BillPayment {
  id        Int       @id @default(autoincrement())
  billId    Int
  bill      Bill      @relation(fields: [billId], references: [id], onDelete: Cascade)
  amount    Float     // valor da parcela
  dueDate   DateTime  @default(now()) // vencimento da parcela
  paidAt    DateTime? // quando foi pago (null = pendente)
  notes     String    @default("")
  createdAt DateTime  @default(now())
  @@index([billId])
}